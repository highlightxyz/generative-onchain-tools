"use strict";import*as THREE from"./lib/three.module.min.js";class TimeManager{constructor(){this.isMutating=!1,this.mutationInterval=0,this.loopCounter=0,this.localTime=0,this.currentSegment=0,this.currentMutation=0,this.mutationValue=0,this.inLoop=!1,this.dt=0}remap(e,t,a,i,n){return(e-t)*(n-i)/(a-t)+i}smoothStep(e){return e*e*(3-2*e)}round(e){return Math.round(1e6*(e+Number.EPSILON))/1e6}getTimeInfo(e){this.dt=this.localTime%e.totalSegments;let t=1;return"Custom"==e.playback?this.dt=this.remap(this.localTime%1,0,1,e.segment-1,e.segment):"Discrete"==e.playback&&(this.dt=e.segment,t=0),this.currentSegment=Math.min(parseInt(this.dt%e.totalSegments),e.totalSegments-1),t}run(e){if("Mutation"==e.playback&&(this.isMutating=!0),!this.isMutating&&!e.trafficEnabled){this.inLoop=!0;let t=e.frameInterval*e.speed*e.active,a=this.getTimeInfo(e);this.currentSegment==e.totalSegments-1&&this.dt>=this.round(e.totalSegments-t)&&(this.loopCounter+=1,this.inLoop=!1),this.loopCounter%e.mutationCycle==0&&this.loopCounter>0&&e.mutationEnabled&&!this.inLoop&&(this.isMutating=!0),this.localTime+=t*a,this.localTime=this.round(this.localTime)}if(this.isMutating&&!e.trafficEnabled){let t=e.frameInterval*e.mutationSpeed;this.mutationInterval+=t;let a=this.smoothStep(this.mutationInterval);this.mutationValue=this.remap(a,0,1,this.currentMutation,this.currentMutation+1),this.mutationInterval>=1&&(this.isMutating=!1,this.mutationInterval=0,this.currentMutation+=1)}}}const round=e=>Math.round(100*(e+Number.EPSILON))/100,toRadians=e=>e*(Math.PI/180),u=e=>({value:e}),toRGB=e=>[((e=Math.floor(e))>>16&255)/255,(e>>8&255)/255,(255&e)/255];function remap(e,t,a,i,n){return i+(n-i)*(e-t)/(a-t)}function getCurrentDate(){const e=new Date,t=e.getFullYear(),a=e.getMonth()+1;return`${e.getDate()}/${a}/${t}`}function createInfoData(e,t){let a=`${t.trafficGradeIndex+1}/${t.trafficLevels.length}`,i=100*t.trafficLevel.toFixed(2)+"%",n=`${parseFloat(t.trafficGas).toFixed(0)} gwei`,o=t.trafficUpdateCounter;return t.trafficAllowed&&t.trafficEnabled||(a=i=n="n/a"),t.trafficError&&(n="n/a"),{title:"Metamorphosis I",date:t.date,loop:e.loopCounter,loopTime:e.dt.toFixed(2),localTime:e.localTime.toFixed(2),mutation:e.currentMutation,transform:e.currentSegment+1,numTransforms:t.totalSegments,transformTime:t.speed.toFixed(2),colorMorphing:t.colorMorphing,colorModeName:t.colorModeName,mutationEnabled:t.mutationEnabled,mutationSpeed:t.mutationSpeed.toFixed(2),mutationCycle:t.mutationCycle,trafficInfo:t.trafficEnabled,trafficGrade:t.trafficGrade,trafficGradeIndex:a,trafficLevel:i,trafficGas:n,trafficUpdate:o,trafficSource:t.trafficSource,mintGasPrice:t.gasPriceMint}}const style="\ntext-align:left; \ntext-align-last:left; \ndisplay:ENABLE; \nz-index:1;\nfont-family: Courier, 'Courier new', monospace;\nfont-size: 14px;\nposition: absolute;\nSIDEV: 0;\nSIDEH: 0;    \ncolor: #ffffff;\nwidth: WIDTH;\nheight: HEIGHT;\nbackground-color: rgba(0,0,0,0.9);\n";function createStatusHTML(e){let t="none";e&&(t="inline-block");const a=document.createElement("div");a.id="info";let i=style.replace("SIDEH","right");i=i.replace("SIDEV","bottom"),i=i.replace("ENABLE",t),i=i.replace("WIDTH","245px"),i=i.replace("HEIGHT","auto"),a.style=i,a.innerHTML=Q("<strong>Metamorphosis I</strong>")+D(`${p.date}`)+U("")+S('<br> Darien Brito, 2024 \n\t\t <br> <a href="https://darienbrito.com/" target="_blank">www.darienbrito.com</a>')+E("<br>"),document.body.appendChild(a)}function createInfoHTML(e){let t="none";e&&(t="inline-block");const a=document.createElement("div");a.id="shortcuts";let i=style.replace("SIDEH","left");i=i.replace("SIDEV","top"),i=i.replace("ENABLE",t),i=i.replace("WIDTH","400px"),i=i.replace("HEIGHT","100%"),i=i.concat("overflow-y:auto;"),a.style=i,a.innerHTML=Q("Shortcuts")+W("shift + ")+E(" \n\t\t<ul>\n\t\t\t<li> p: show parameters.</li>\n\t\t\t<li> s: show status.</li>\n\t\t\t<li> i: show info.</li>\n\t\t\t<li> spacebar: play/pause. </li>\n\t\t\t<li> e: export image at 4k. </li>\n\t\t\t<li> o: export image at 8k (in parts). </li>\t\t\t\n\t\t</ul>\n\t\t")+W("alt + ")+E("\n\t\t<ul>\n\t\t\t<li> 0: adaptive aspect ratio. </li>\n\t\t\t<li> 1: vertical (3/4) </li>\n\t\t\t<li> 2: horizontal (4/3) </li>\n\t\t\t<li> 3: square (1/1) </li>\n\t\t\t<li> 4: horizontal (16/9) </li>\n\t\t\t<li> 5: vertical (9/16) </li>\n\t\t</ul>\n\t\t")+Q("Parameters")+T("Aspect ratio")+E("<br> You may choose common ratios from the parameters panel or use the shortcuts above. The default is adaptive, which fits the piece dynamically to the current screen size.")+T("Colors")+E("<br> The color palette is defined on mint time and may not be changed, but you can always customize how to use color in the piece.")+E("\n\t\t<ul>\t\n\t\t\t<li> Morphing: enable/disable color mutation.\n\t\t\t<li> Mode:\n\t\t\t<ul>\t\n\t\t\t\t<li> Solid\n\t\t\t\t<li> Texture\n\t\t\t\t<li> Gradient\n\t\t\t</ul>\n\t\t\t<li> Rotation: reorder the color palette.\n\t\t</ul>\n\t\t")+T("Transformation")+E("<br> You can change the speed of transforms. If you want a perfect loop you must <u>disable mutation</u>.")+E("\n\t\t<ul>\t\n\t\t\t<li> Speed: time multiplier.\n\t\t</ul>\n\t\t")+T("Mutation")+E("<br> While transforms create a perfect loop, mutation is an optional extra step that mutates the landscape to produce never-ending variations. It is <u>enabled by default</u>.")+E("\n\t\t<ul>\n\t\t\t<li> Enable: on/off </li>\n\t\t\t<li> Cycle: loops to wait before mutating. </li>\n\t\t\t<li> Speed: time multiplier.\n\t\t\t<li> Magnitude: how far to mutate. </li>\n\t\t</ul>\n\t\t")+T("Animation")+E('<br> The animation can be played or stopped, and can run in four different modes. "Full" is the default. Note that a "segment" is one of the steps in a loop. Segments are counted from zero.')+E("\n\t\t<ul>\n\t\t\t<li> Play: on/off </li>\n\t\t\t<li> Mode \n\t\t\t\t<ul>\n\t\t\t\t\t<li> Full: all segments plus mutation.\n\t\t\t\t\t<li> Custom: selected segment animated. \n\t\t\t\t\t<li> Discrete: selected segment static. \n\t\t\t\t\t<li> Mutation: mutation only. \n\t\t\t\t</ul>\n\t\t\t</li>\n\t\t\t<li> Segment\n\t\t</ul>\n\t\t")+T("Traffic mode")+E('<br> A visualization of the Ethereum network\'s current activity level. When activated, it overrides all playback settings; <u>the busier the network is, the slower the blocks move</u>. Traffic mode works with real-time network data, typically displaying "live" on the status panel (<i>shift+s</i>). However, excessive queries can cause an "on mint" status, indicating potential data unreliability. Downtime may occur. Please try later for live data access.')+E("\n\t\t<ul>\n\t\t\t<li> Activate: on/off </li>\n\t\t\t<li> Axis: select motion direction. </li>\n\t\t\t<li> Invert: invert motion direction.\n\t\t</ul>\n\t\t")+Q("Performance")+E("<br> <i>Metamorphosis I</i> requires a capable GPU to run at 60fps. If the animation is not smooth, try to adjust <i>System</i> and <i>Shadows</i> settings in the parameters. You may have unexpected results running on mobile. Be mindful that the pieces were composed for a large screen and modern hardware.")+T("System")+E("\n\t\t<ul>\n\t\t\t<li> Rendering: on/off</li>\n\t\t\t<li> FPS: change the frame rate.</li>\n\t\t\t<li> Ethereum: allow traffic queries.</li>\n\t\t</ul>\n\t\t")+T("Shadows")+E("\n\t\t<ul>\n\t\t\t<li> Type </li>\n\t\t\t<ul>\n\t\t\t\t<li> Soft  </li>\n\t\t\t\t<li> Hard (cheaper) </li>\n\t\t\t</ul>\n\t\t\t<li> Quality</li>\n\t\t\t<ul>\n\t\t\t\t<li> Medium </li>\n\t\t\t\t<li> High (default)</li>\n\t\t\t\t<li> Ultra </li>\n\t\t\t</ul>\n\t\t</ul>\n\n\t\t")+Q("Exporting")+E("<br> I made <i>Metamorphosis I</i> for the digital realm. It is meant to be animated, <u>running in real-time</u>. It is not intended as a static piece.\n\t\t<br><br>\n\t\tHowever, if you must, two high quality options for snapshots are available: 4k and 8k. Use the buttons in the parameters or the shortcuts described at the beginning. Be aware that due to web limitations, exporting at 8k results in nine different parts of the image, which you can then stitch together in your software of choice.")+E("<br> If you would like to have a high quality video render of your piece please get in touch.")+S('<br> Darien Brito, 2024 \n\t\t <br> <a href="https://darienbrito.com/" target="_blank">www.darienbrito.com</a>')+E("<br>"),document.body.appendChild(a)}function E(e){return`<div class=dataEntry > ${e} </div>`}function U(e){return`<div class=dataEntry id="updateTxt"> ${e} </div>`}function Q(e){return`<div class=dataTopic> ${e} </div>`}function T(e){return`<div class=dataTitle> ${e} </div>`}function S(e){return`<div class=dataSignature> ${e} </div>`}function D(e){return`<div class=dataDate> ${e} </div>`}function W(e){return`<div class=dataMacro> ${e} </div>`}function updateInfo(e,t,a){t=t.toFixed(2);let i="";e.trafficInfo&&(i=`\n\t\t<li>Source: ${e.trafficSource}</li>\n\t\t<li>Traffic level: ${e.trafficLevel}</li>\n\t\t<li>Traffic grade: ${e.trafficGradeIndex}</li>\n\t\t<li>Next update: ${e.trafficUpdate}</li>\n\t\t`);document.getElementById("updateTxt").innerHTML=`\n\t<br>\n\t<ul class=nB>\n\t\t<li>Global time: ${t}</li>\n\t\t<li>Local time: ${e.localTime} </li>\n\t\t<li>Loop time: ${e.loopTime} </li>\n\t\t<li>FPS: ${a} </li>\n\t</ul>\n\t<br>\n\t<ul class=nB>\n\t\t<li>Loop: ${e.loop}</li>\n\t\t<li>Mutation: ${e.mutation}</li>\n\t\t<li>Transform: ${e.transform}/${e.numTransforms}</li>\n\t</ul>\t\t\n\t<br>\n\t<ul class=nB>\n\t\t<li>Traffic: ${e.trafficGrade} </li> \n\t\t${i}\n\t</ul>\t\t\n\t<br>\n\t<ul class=nB>\n\t\t<li>Gas on mint: ${e.mintGasPrice} gwei</li>\n\t\t<li>Current gas: ${e.trafficGas}</li>\n\t</ul>\t\n\t<br>\n\t<ul class=nB>\n\t\t<li>Edition: ${hl.tx.tokenId}/${p.collectionSize}</li>\n\t</ul>\t\n\t<br>\n\t`}function createContainer(e){const t=document.createElement("div");return t.appendChild(e.domElement),document.body.appendChild(t),t}window.mobileCheck=function(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e};const ratioModes={0:"Adaptive",1:3/4,2:4/3,3:1,4:16/9,5:9/16},ratioNames={Adaptive:0,"3/4":1,"4/3":2,"1/1":3,"16/9":4,"9/16":5};function getDim(e,t=null){let a=ratioModes[e.ratioMode];e.adaptive="Adaptive"===a,e.isMobile&&(e.adaptive=!0);let i=window.innerHeight,n=window.innerHeight;return null!==t&&(i=n=t),i*=a,e.adaptive&&(i=window.innerWidth,n=window.innerHeight,a=window.innerWidth/window.innerHeight),{x:i,y:n,a:a}}let defines="\n#define UM uniform\n#define VV varying\n#define AT attribute\n#define FT flat\n#define V2 vec2\n#define V3 vec3\n#define V4 vec4\n#define iV2 ivec2\n#define iV3 ivec3\n#define iV4 ivec4\n#define FV float\n#define FI int \n#define CF const\n#define FF floor\n#define DF dot\n#define MF mod\n#define AF abs\n#define SF step\n#define ST smoothstep\n#define CM clamp\n#define FR fract\n#define LN length\n#define MX mix\n#define RF return\n#define VD void\n",simplexNoise=`${defines} V4 permute(V4 x){RF MF(((x*34.0)+1.)*x,289.);}V4 taylorInvSqrt(V4 r){RF 1.79284291400159-0.85373472095314*r;}FV snoise(V3 v){CF V2 C=V2(1./6.0,1./3.);CF V4 D=V4(0.,.5,1.,2.);V3 i =FF(v+DF(v,C.yyy));V3 x0 =v-i+DF(i,C.xxx) ;V3 g=SF(x0.yzx, x0.xyz);V3 l=1.-g;V3 i1=min( g.xyz, l.zxy );V3 i2=max( g.xyz, l.zxy );V3 x1=x0-i1+1.*C.xxx;V3 x2=x0-i2+2.*C.xxx;V3 x3=x0-1.+3.*C.xxx;i=MF(i, 289.0 );V4 p=permute(permute(permute(i.z+V4(0.,i1.z,i2.z,1.))+i.y+V4(0.,i1.y,i2.y,1.))+i.x+V4(0.,i1.x,i2.x,1.));FV n_=1./7.;V3 ns=n_*D.wyz-D.xzx;V4 j=p-49.*FF(p*ns.z*ns.z);V4 x_=FF(j*ns.z);V4 y_=FF(j-7.*x_);V4 x=x_*ns.x+ns.yyyy;V4 y=y_*ns.x+ns.yyyy;V4 h=1.-AF(x)-AF(y);V4 b0=V4(x.xy,y.xy);V4 b1=V4(x.zw,y.zw);V4 s0=FF(b0)*2.+1.;V4 s1=FF(b1)*2.+1.;V4 sh =-SF(h,V4(0.));V4 a0=b0.xzyw+s0.xzyw*sh.xxyy;V4 a1=b1.xzyw+s1.xzyw*sh.zzww;V3 p0=V3(a0.xy,h.x);V3 p1=V3(a0.zw,h.y);V3 p2=V3(a1.xy,h.z);V3 p3=V3(a1.zw,h.w);V4 norm=taylorInvSqrt(V4(DF(p0,p0),DF(p1,p1),DF(p2, p2),DF(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;V4 m=max(.6-V4(DF(x0,x0),DF(x1,x1),DF(x2,x2),DF(x3,x3)),0.);m=m*m;RF 42.*DF(m*m,V4(DF(p0,x0),DF(p1,x1),DF(p2,x2),DF(p3,x3)));}`;function getRenderTarget(e,t,a,i){const n=new THREE.WebGLRenderTarget(e,t,a),o=new THREE.OrthographicCamera(-1,1,1,-1,0,1),r=new THREE.Scene,s=new THREE.PlaneGeometry(2,2),l=new THREE.Mesh(s,i);return r.add(l),{target:n,scene:r,camera:o}}function writeStaticTexture(e,t,a,i){const n=getRenderTarget(t[0],t[1],a,i);return e.setRenderTarget(n.target),e.render(n.scene,n.camera),e.setRenderTarget(null),n.target.texture}function getNoiseShader(e,t){const a=new THREE.ShaderMaterial({uniforms:t,vertexShader:`${defines} VV V2 vUv;VD main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*V4(position,1.);}`,fragmentShader:`${defines} VV V2 vUv;UM FV uTime;UM V2 uRes;UM FV uSeed;UM FV uFreq;UM FV uShift;UM V2 uTraffic; ${simplexNoise} FV fbm(V3 x, FV H ){FV G=exp2(-H);FV f=1.;FV a=1.;FV t=0.;for(FI i=0;i<${e};i++){t+=a*snoise(f*x);f*=2.;a*=G;}RF t;}VD main(){V2 uv=vUv;FV a=uRes.x/uRes.y;uv.x*=a;V2 tfc=V2(uTime)*uTraffic;FV r=fbm(V3(uv.xy*uFreq+uSeed+tfc,uShift),1.);FV g=fbm(V3(uv.yx*uFreq+uSeed+tfc+100.,uShift),1.);FV b=fbm(V3(uv.xy*uFreq+uSeed+tfc+200.,uShift),1.);gl_FragColor=V4(CM(V3(r,g,b)*.5+.5,0.,1.),1.);}`}),i={wrapS:THREE.RepeatWrapping,wrapT:THREE.RepeatWrapping,generateMipmaps:!0,format:THREE.RGBAFormat,type:THREE.FloatType,depthBuffer:!1};return p.extFloatLinear?(i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter):(i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter),{shader:a,options:i}}function createNoiseTexture(e,t,a,i,n,o){const r=getNoiseShader(o,{uTime:u(0),uRes:u(t),uSeed:u(a),uFreq:u(i),uShift:u(n),uTraffic:u([0,0])});return{shader:r,texture:writeStaticTexture(e,t,r.options,r.shader)}}function getTextureShader(e){const t=e.palette,a=new THREE.ShaderMaterial({uniforms:{uC1:u(toRGB(t[0])),uC2:u(toRGB(t[1])),uC3:u(toRGB(t[2])),uC4:u(toRGB(t[3])),uC5:u(toRGB(t[4])),uN:u(e.textureNumColors),uTF:u(e.textureFamily)},vertexShader:`${defines}\n    VV V2 vUv; VD main(){gl_Position=projectionMatrix*modelViewMatrix*V4(position,1.);vUv=uv;}`,fragmentShader:`${defines}\n#define S (${e.texturesSmooth}./FV(${e.texturesDim}))\n#define eif else if\nVV V2 vUv; UM V3 uC1; UM V3 uC2;UM V3 uC3;UM V3 uC4;UM V3 uC5;UM FI uN;UM FI uTF;FV bx(V2 p,V2 b){V2 d=AF(p)-b;RF LN(max(d,0.0))+min(max(d.x,d.y),0.0);}FV rc(V2 uv,V2 s){uv=uv*2.-1.;RF 1.-SF(0.,bx(uv,s));}FV ci(V2 uv){RF 1.-ST(.5-S/2.,.5+S/2.,LN(uv*2.-1.));}V3 sC(V2 uv,V3 p[5],FI o,FV s){FV r=LN(uv-.5);RF MX(p[(0+o)%uN],p[(1+o)%uN],ST(S/2.,-S/2.,r-s));}V3 sR(V2 uv,V3[5] p,FI o,FV s){RF MX(p[(2+o)%uN],p[(3+o)%uN],SF(bx(uv-.5,V2(s)),0.));}V3 sT(FV a,V3 p[5], FI o,FV f){FI i=(FI(a*f)+o)%uN;RF p[i];}V3 rR(V2 uv,V3[5] p,FV s,FI o,FI it){V3 c=p[(0+o)%uN];FV f=(1./FV(it))*s;for(FI i=0;i<it;i++){FV a=1./FV(i);c=MX(c,p[((i+1)+o)%uN],rc(uv,V2(1.-(f*FV(i+1)))));}RF c;}V3 m(V3[5]p,FI a,FI b,FV v){RF MX(p[a],p[b],v);}V4 p1(FI n,V2 uv,V3[5] p){V3 c=V3(0.);FV v=FV(n);if (n==1)c=sR(uv,p,0, .15);eif(n==2)c=sR(uv,p,1,.2);eif(n==3)c=sR(uv,p,2,.25);eif(n==4)c=sR(uv,p,3,.3);eif(n==5)c=sR(uv,p,4, .35);eif(n==6)c=sR(uv,p,0,.35);eif(n==7)c=sR(uv,p,1,.35);eif(n==8)c=sR(uv,p,2,.35);eif(n==9)c=rR(uv,p,1.,3,4);RF V4(c,1.);}V4 p2(FI n,V2 uv,V3[5] p){V3 c;V2 q=FR(uv*5.);V2 k=uv;if (n==1) c=sC(q,p,0,.2);eif(n==2)c=sC(q,p,1,.2);eif(n==3)c=sC(q,p,2,.2);eif(n==4)c=sC(q,p,3,.2);eif(n==8)c=sC(q,p,4,.2);eif(n==5)c=sC(k,p,0,.1);eif(n==6)c=sC(k,p,1,.2);eif(n==7)c=sC(k,p,2,.25);eif(n==9)c=sC(k,p,3,.3);RF V4(c,1.);}V4 p3(FI n,V2 uv,V3[5] p){V3 c=V3(0.);FV v=FV(n);V2 q=FR(uv*6.);if(n==1)  c=sR(uv,p,4,.25);eif(n==2)c=sR(q,p,0,.3);eif(n==3)c=sR(q,p,1,.3);eif(n==4)c=sR(q,p,2,.3);eif(n==5)c=sR(q,p,3,.3); eif(n==6)c=sR(q,p,0,.3);eif(n==7)c=sT(uv.x,p,1,2.);eif(n==8)c=sT(uv.y,p,2,2.);eif(n==9)c=sR(uv,p,3,.25);RF V4(c,1.);}V4 p4(FI n,V2 uv,V3[5] p){FV s; V3 c;FV v=ci(uv);if(n==1)c=m(p,2,2,v);eif(n==2)c=m(p,3,2,v);eif(n==3)c=m(p,4,3,v);eif(n==4)c=m(p,0,0,v);eif(n==5)c=m(p,0,1,v);eif(n==6)c=m(p,0,2,v);eif(n==7)c=m(p,0,3,v);eif(n==8)c=m(p,1,4,v);eif(n==9)c=m(p,2,0,v); RF V4(c,1.);}V4 p5(FI n,V2 uv,V3[5] p){V3 c;V2 q=FR(uv*5.);V2 k=uv;FV s=.05;if(n==1)c=sC(q,p,0,s);eif(n==2)c=sC(q,p,1,s*2.);eif(n==3)c=sC(q,p,2,s*3.);eif(n==4)c=sC(q,p,3,s*4.);eif(n==5)c=sC(q,p,4,s*5.);eif(n>=6)c=sC(q,p,n%5,.1);RF V4(c,1.);}VD main(){V2 uv=vUv;ivec2 n=ivec2(uv*3.);V2 f=FR(uv*3.);FI idx=n.x+n.y*3+1;V3 k[5] = V3[5](uC1,uC2,uC3,uC4,uC5);V4 c;if(uTF==1)c=p1(idx,f,k);eif(uTF==2)c=p2(idx,f,k);eif(uTF==3)c=p3(idx,f,k);eif(uTF==4)c=p4(idx,f,k);eif(uTF==5)c=p5(idx,f,k);gl_FragColor=c;}`}),i={wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,generateMipmaps:!0,format:THREE.RGBAFormat,type:THREE.FloatType,depthBuffer:!1};return e.extFloatLinear?(i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter):(i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter),{shader:a,options:i}}function createTexturesTexture(e,t,a,i){u(toRGB(a.palette[0])),u(toRGB(a.palette[1])),u(toRGB(a.palette[2])),u(toRGB(a.palette[3])),u(toRGB(a.palette[4]));const n=getTextureShader(a,i);return{shader:n,texture:writeStaticTexture(e,t,n.options,n.shader)}}function customConstantMaterial(e,t){return e.uniforms=t,e.vertexShader=`${defines}\nUM FV uS;UM iV2 uD;AT FI aID;VD main() {FI id=aID;V3 P=position;V2 u=1./V2(uD);V2 xy=V2(id%uD.x,id/uD.x);V2 uv=(xy/V2(uD))+(u*.5);V2 sg=uv-.5;V3 pos=V3(sg.x,sg.y,0.)-V3(u*.5,0.);V3 s=V3(1./V2(uD),1.);V3 nP=P*s*uS;nP+=V3(pos);gl_Position=projectionMatrix * modelViewMatrix * V4(nP, 1.0);}`,e.fragmentShader=`${defines}\nUM V3 uC;void main(){gl_FragColor=V4(uC,1.);}`,e}function customPhongMaterial(e,t,a,i){e.uniforms=t;const n=`${defines}\n#include <common>\n#define TAU 6.2831853071\n#define TEXTURE 1\n#define GRADIENT 2\nUM V3 uC1;UM V3 uC2;UM V3 uC3;UM V3 uC4;UM V3 uC5;UM FI uNC;UM FI uCM;UM FI uSeg;UM FV uTime;UM iV2 uD;UM FI uTr;UM sampler2D sNoise;UM FV uMSm;VV V4 vData;VV V3 vS;VV V3 vR;VV V3 vT;VV V3 vC;FT VV V4 v_color;VV FV v_randVal;FT VV FI v_id;FT VV V3 v_dimension;FT VV iV2 v_colIdxData;VV V2 v_rand;VV V2 v_gridUV;VV V2 v_colorMorph; VV V3 v_noise;VV V3 v_sameUV;FT VV FI v_face;VV V3 v_normal;FV phaser(FV pct, FV ph, FV e){RF CM((ph-1.+ pct*(1.+e))/e,0.,1.);}V3 muta(V3 from, V3 to, FV seg, FV time, FV ph, FV edge, FV smo){time=CM(time,seg,seg+1.)*SF(seg,time)-seg;FV t=phaser(time,ph,edge);RF MX(from,to,ST(smo,1.-smo,t));}`,o=`UM FV uSc;UM FV uSeed;AT FI aID;struct Init{V2 uv;V2 xy;V3 pos;FV scale;FV rand;V3 noise;};Init getData(FI id){Init o;V2 un=1./V2(uD);o.xy=V2(id%uD.x,id/uD.x);o.uv=(o.xy/FV(uD.x))+(un*.5);V2 sgn=o.uv-.5;o.pos=V3(sgn.x,0.,sgn.y) ;o.scale = (1./FV(uD.x));RF o;}\n${i}\nFV cir(V2 xy,FV r,FV dir){FV s=dir*2.-1.;RF dir-s*ST(0.,r,LN(xy));}FV cGr(V2 xy,FV freq,FV dir){FV a=atan(xy.y,xy.x);FV s=dir*2.-1.;RF dir-s*MF(a*freq,PI)/PI;}FV rGr(V2 xy,FV freq,FV dir){FV s=dir*2.-1.;FV a=LN(xy)*freq;RF dir - s*FR(a);}FV dGr(V2 uv,FV freq,FV dir){FV s=dir*2.-1.;RF dir-s*FR((uv.x*.5+uv.y*.5)*freq);}FV diGr(V2 uv,FV freq,FI dir){FV x=dir>0?uv.x:uv.y;RF FR(x*freq);}FV zza(V2 uv,FV freq,FI dir){V2 xy=dir>0?uv.xy : uv.yx;FV g=FF(xy.x*freq);g=MX(g,g+2., MX(xy.y,1.-xy.y,MF(g,2.)));FV phase=g/(freq+2.-1.);RF phase;}FV spi(V2 uv,FV f,FV dir){V2 p=uv-.5;FV theta = (atan(p.y,p.x)+PI)/TAU;FV r=LN(uv-0.5)*f;FV s=dir*2.-1.;RF dir - s*FR(r+theta);}V4 hash41(FV p){V4 p4=FR(V4(p) * V4(.1031,.1030,.0973,.1099));p4 += DF(p4,p4.wzxy+33.33);RF FR((p4.xxyz+p4.yzzw)*p4.zywx);}mat4 rotationMatrix(V3 a,FV t){a=normalize(a);FV s=sin(t);FV c=cos(t);FV oc=1.-c;RF mat4(oc*a.x*a.x+c,oc*a.x*a.y-a.z*s,oc*a.z*a.x+a.y*s,0.,oc*a.x*a.y+a.z*s,oc*a.y*a.y+c,oc*a.y*a.z-a.x*s,0.,oc*a.z*a.x-a.y*s,oc*a.y*a.z+a.x*s,oc*a.z*a.z+c,0.,0.,0.,0.,1.);}iV2 colorSelector(FI vid,iV2 offset,iV2 lim){iV2 cIdx=offset;if(vid<8) cIdx += 1;else if(vid<16) cIdx+=2;else if(vid<24)cIdx+=3;RF iV2(cIdx.x%lim.x,cIdx.y%lim.y);}FI faceSelector(FI vid){FI idx=0;if(vid<8)idx=1;else if(vid<16)idx=2;else if(vid<24)idx=3;RF idx;}V3 uvSelector(FI vid){V3 uvs[4]=V3[4](V3(0.),V3(1.,0.,0.),V3(0.,0.,1.),V3(1.,0.,1.));V3 uv=uvs[vid] - 0.5;RF uv;}`,r="FI vid=gl_VertexID;FI id=aID;FI face=faceSelector(vid);FI iSeed=FI(uSeed);vData=V4(vid,id,face,iSeed);FV dt=uTime;FI i=uSeg;V3 colors[5] = V3[5](uC1,uC2,uC3,uC4,uC5);Init o=getData(id);V4 rand=hash41(FV(id+iSeed));V3 noise=CM(AF(texture(sNoise,o.uv).xyz),0.,1.);o.rand=rand.x;o.noise=noise;V3 curveData=mutationCurves[i];FI curve=FI(curveData.x);FV freq=curveData.y;FI dir=FI(curveData.z);FV fdir=FV(dir);V2 xy=o.uv*2.-1.;FV g[9] = FV[9](cir(xy,freq,fdir),cGr(xy,freq,fdir),rGr(xy,freq,fdir),dGr(o.uv,freq,fdir),diGr(o.uv,freq,dir),zza(o.uv,freq,dir),spi(o.uv,freq,fdir),rand.x,noise.x);V3 displacement;displacement=V3(1.,MX(1.,10.,ST(.5,1.,noise.x)),1.);Data d=getTransforms(o,displacement);FI randOffsetCol=FI(noise.x*4.99);FI randOffsetTex=FI(noise.x*8.99);iV2 colorData=colorSelector(vid,iV2(randOffsetCol,randOffsetTex),iV2(uNC,9));FI colorIdx=colorData.x;FI textureIdx=colorData.y;V3 s=V3(o.scale);V3 t=o.pos;V3 r=V3(0.);V3 c=colors[colorIdx];FV phase=g[curve];FV edge=MX(.33,.66,phase);if(i>0){FI idx=i-1;s=d.sVals[idx]*o.scale;r=d.rVals[idx];t=d.tVals[idx]*o.scale+o.pos;}V3 toS=d.sVals[i]*o.scale;V3 toR=d.rVals[i];V3 toT=d.tVals[i]*o.scale+o.pos;s=muta(s,toS,FV(i), dt,phase,edge,uMSm);s*= displacement;r=muta(r,toR,FV(i),dt,phase,edge,uMSm);t=muta(t,toT,FV(i), dt,phase,edge,uMSm);vS=s;vR=r;vT=t;vC=c;",s="V3 P=transformed;mat4 rotaMat=rotationMatrix(V3(1.,0.,0.),radians(vR.x))*rotationMatrix(V3(0.,1.,0.),radians(vR.y))*rotationMatrix(V3(0.,0.,1.),radians(vR.z));V3 newPos=P*vS*uSc;newPos=(rotaMat*V4(newPos,1.)).xyz;newPos+=vT;FV vID=vData.r;FV iId=vData.g;FV seed=vData.b;transformed=newPos;";return e.onBeforeCompile=e=>{for(const a in t)e.uniforms[a]=t[a];e.vertexShader=e.vertexShader.replace("#include <common>",`\n\t        ${n}\n\t        ${o}\n        `),e.vertexShader=e.vertexShader.replace("#include <beginnormal_vertex>",`#include <beginnormal_vertex>\n${r}\nmat4 rotMat =rotationMatrix(V3(1.,0.,0.),radians(r.x))*rotationMatrix(V3(0.,1.,0.),radians(r.y))*rotationMatrix(V3(0.,0.,1.),radians(r.z));V3 newNor=(rotMat*V4(objectNormal,1.)).xyz;objectNormal=newNor;V4 newColor=V4(c,1.);v_color=newColor;v_normal=objectNormal;v_rand=rand.xy;v_randVal=rand.w;v_id=id;v_dimension=s;v_colIdxData=iV2(colorIdx, textureIdx);v_gridUV=o.uv;v_colorMorph=V2(phase, edge);v_noise=noise;v_sameUV=uvSelector(vid%4);v_face=face;`),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`\n            #include <begin_vertex>\n            ${s}\n        `),e.fragmentShader=e.fragmentShader.replace("#include <common>",`\n        \t${n}\n        \tUM FI uMode;UM sampler2D sTex;UM FI uTexDim;UM V3 uPp;mat2 rotate(FV a){FV c=cos(a),s=sin(a);RF mat2(c,-s,s,c);}V2 hash21(FV p){V3 p3=FR(V3(p)*V3(.1031,.1030,.0973));p3+=DF(p3,p3.yzx+33.33);RF FR((p3.xx+p3.yz)*p3.zy);}FV hash12(V2 p){V3 p3=FR(V3(p.xyx)*.1031);p3+=DF(p3,p3.yzx+33.33);RF FR((p3.x+p3.y)*p3.z);}V2 hash22(V2 p){V3 p3=FR(V3(p.xyx)*V3(.1031,.1030,.0973));p3+=DF(p3,p3.yzx+33.33);RF FR((p3.xx+p3.yz)*p3.zy);}V2 gLUV(V2 uv,FI texID,V2 size,FV smallest,FI m){FI texDim=uTexDim;V2 atlasDim=V2(texDim*3,texDim*3);iV2 xy=iV2(texID%3,texID/3);V2 capUV=(uv*size)/smallest;iV2 readXY=iV2(capUV*FV(texDim))+iV2(xy*texDim);V2 readUV=V2(readXY)/atlasDim;readUV=readUV+(1./6.);RF m<1?CM(readUV,0.,1.):readUV;}\nV4 readS(V2 uv,V4 inCol){V4 c=inCol;FI i=uSeg;V3[5] pl=V3[5](uC1,uC2,uC3,uC4,uC5);int cid=v_colIdxData.x;if(uCM>0){c.rgb=pl[(cid+i)%uNC];if(i!=(uTr-1))cid=(cid+i+1)%uNC; }V3 toC=pl[cid];c.rgb=muta(c.rgb,toC,FV(i),uTime,v_colorMorph.x,v_colorMorph.y,uMSm);FV axis=MX(uv.x,uv.y,ST(0.,1.,v_randVal));c.rgb=MX(c.rgb,c.rgb*.75,axis);c.a=c.a;RF c;}\nV4 readT(V2 genUV,V4 inCol,inout V2 pUV){FI face=v_face;V2 size=v_dimension.xy;FV smallest=min(v_dimension.x,v_dimension.y);if(face==2){size=v_dimension.xz;smallest=min(v_dimension.x,v_dimension.z);}FI cid=v_colIdxData.y;V2 uv=gLUV(genUV,cid,size,smallest,1);FI i=uSeg;V4 c=texture(sTex,uv);c.a*=inCol.a;if(uCM>0){c.rgb=texture(sTex,gLUV(genUV,(cid+i)%9,size,smallest,1)).rgb;if(i!=(uTr-1)){cid=(cid+i+1)%9;}}V3 toCol=texture(sTex,gLUV(genUV,cid,size,smallest,1)).rgb;c.rgb=muta(c.rgb,toCol,FV(i),uTime,v_colorMorph.x,v_colorMorph.y,uMSm);pUV=uv;RF c;}V4 readGradient(V2 genUV,V4 inCol){V3[5] pl=V3[5](uC1,uC2,uC3,uC4,uC5);FI face=v_face;V2 size=v_dimension.xy;FV smallest=min(v_dimension.x,v_dimension.y);if(face == 2){size=v_dimension.xz;smallest=min(v_dimension.x,v_dimension.z);}V2 uv=gLUV(genUV,v_colIdxData.y,size,smallest,0);FI i=uSeg;iV2 idx=iV2(v_noise.xy*4.99);FV axis=MX(uv.x,uv.y,ST(0.,1.,v_randVal));V3 c=MX(pl[idx.x%uNC],pl[idx.y%uNC],axis);if(uCM>0){c.rgb=MX(pl[(idx.x+i)%uNC], pl[(idx.y+i)%uNC],axis);if(i!=(uTr-1)){idx=(idx+i+1)%uNC;}}V3 toCol=MX(pl[idx.x%uNC],pl[idx.y%uNC],axis);c=muta(c,toCol,FV(i),uTime,v_colorMorph.x,v_colorMorph.y,uMSm);RF V4(c,1.);}\n        `),e.fragmentShader=e.fragmentShader.replace("vec4 diffuseColor = vec4( diffuse, opacity );","V4 diffuseColor=V4(diffuse,opacity);V4 color=diffuseColor;V2 uv=v_sameUV.xz;V2 pUV=uv;if(uMode==TEXTURE)color=readT(uv,v_color,pUV);else if(uMode==GRADIENT)color=readGradient(uv,v_color);else color=readS(uv,v_color);FV axis=MX(pUV.x,pUV.y,ST(0.,1.,v_randVal));color.rgb=MX(color.rgb,color.rgb*uPp.x, axis);V2 noise=hash22(FV(v_id)*pUV);FV beautyNoise=noise.x;FV beautyAlpha=ST(uPp.y,1.,noise.y);color.rgb=MX(color.rgb,color.rgb*V3(beautyNoise)*uPp.z,beautyAlpha);color.rgb=CM(color.rgb,0.,1.);diffuseColor=color;")},a.onBeforeCompile=e=>{for(const a in t)e.uniforms[a]=t[a];e.vertexShader=e.vertexShader.replace("#include <common>",`\n\t        ${n}\n\t        ${o}\n        `),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`\n            #include <begin_vertex>\n            ${r}\n            ${s}\n        `)},[e,a]}const palettes={Gori:[141100,14324297,14438154,10885634,14866146],Maki:[197379,1004811,16777215,2122724,855309],Lumo:[328707,14730131,11237201,5838858,3817782],Renbo:[5002002,13712654,13573130,14317335,1454123],Dore:[6258013,1723465,857115,657422,12369007],Pluck:[1924973,7449934,15709764,14815e3,1253674],Luha:[1182225,3475978,5850156,12351266,2107185],Prime:[16579836,15431442,13699846,723981,2064031],Aiced:[12952660,5536613,3424310,1249550,8870932],Golbe:[0,13058564,15954187,16777215,921102],Rubik:[592137,414573,6258693,15817222,15532033],Keon:[679750,7898631,14474892,13570317,395019],Chigu:[15127216,551796,7707003,12518419,723723],Deserta:[1909020,6638380,16431505,10917756,9843209],Grayscale:[263172,14342874,263172,14342874,263172],Nove:[14445593,13569558,1708308,4490352,14733699],Aqua:[119144,101240,91787,80267,72587],Sirne:[4406,19452,19452,13155760,6080523],Mehne:[14078407,11058830,4690036,789e3,10754307],Oliah:[13089693,262915,9853444,2972002,10421504]};let transformPresets={4:{0:{s:[[.75],[.75],[1,1.5,1],[1]],r:[[0,45,0],[0,45,0],[0,180,0],[0,360,0]],t:[[2,1,1],[2,1,0],[0],[0]],c:[[6,2],[4,1],[5,3],[4,2]]},1:{s:[[.5,1.25,.5],[1],[1,.5,1],[1]],r:[[0,180,0],[0,180,0],[0,180,0],[0,360,0]],t:[[0],[1,2,1],[1,0,1],[0]],c:[[0,1],[7,2],[3,1],[0,1]]},2:{s:[[1,"1./q.y",1],[.5,1,.5],[.75,1,.75],[1]],r:[[0],[0],[0,-45,0],[0]],t:[[1],[1,2,1],[1,0,1],[0]],c:[[5,2],[8,2],[0,1],[6,1]]},3:{s:[[1],[.33],[.33],[1]],r:[[0],[0,0,90],[0,0,90],[0]],t:[[3,0,3],[0],[-2,1,-1],[0]],c:[[1,40],[8,2],[5,4],[2,3]]},4:{s:[[1],[1,"1./q.y",1],[.5],[1]],r:[[0,"cos(o.uv.y*TAU)*180.",0],[0],[0,"cos(o.uv.y*TAU)*-90.",0],[0]],t:[[0],[0],[1,1,0],[0]],c:[[4,1],[8,2],[5,4],[8,4]]},5:{s:[[.5],[.5,1.5,.5],[1,.25,.25],[1]],r:[[0],[0],[0,360,0],[0,360,0]],t:[[0],[0,1,0],[0],[0]],c:[[1,3],[8,2],[6,3],[3,2]]},6:{s:[[1],[.5],[.25],[1]],r:[[0],[0],[0,360,0],[0,360,0]],t:[[0,1,0],[1,0,1],[1,0,1],[0]],c:[[2,3],[8,2],[2,1],[5,8]]},7:{s:[["(cos(o.uv.x*TAU*10.)*(sin(o.uv.y*TAU*10.))*.5+.6)"],["(cos(o.uv.x*TAU*5.)*(sin(o.uv.y*TAU*5.))*.5+.6)"],["(cos(o.uv.x*TAU*2.5)*(sin(o.uv.y*TAU*2.5))*.25+.75)"],[1]],r:[[0],[0,180,0],[0],[0,360,0]],t:[[0],[0,1,0],[0],[0]],c:[[8,3],[8,2],[7,4],[8,8]]},8:{s:[["o.rand"],["o.rand"],["1./q.x","1./q.y","1./q.z"],[1]],r:[[0,-90,0],[0],[0,90,0],[0]],t:[[0],[1,0,0],[0,0,1],[0]],c:[[8,3],[4,1],[8,4],[8,8]]},9:{s:[["o.rand * .5"],["o.rand * .5"],["o.rand * .5"],[1]],r:[[0],[0],[0],[0,360,0]],t:[[0],["cos(o.uv.x*PI) * 5.",0,0],["cos(o.uv.x*TAU) * 5.",0,"sin(o.uv.y*TAU) * 5."],[0]],c:[[0,1],[8,1],[8,5],[8,3]]},10:{s:[[1,"1./q.y",1],[1,"1./q.y",1],[.5,"1./q.y*.5",.5],[1]],r:[[0,180,0],[90],[0,90,90],[0]],t:[[0],[0,"cos(o.uv.x*o.uv.y*TAU*3.)*2.+1.",0],[0],[0]],c:[[0,1],[7,1],[5,5],[8,3]]}},5:{0:{s:[[1,.25,1],["cos(o.rand*TAU*10.)*.25+.75",1,"sin(o.rand*TAU*10.)*.25+.75"],["1./q.x","1./q.y","1./q.z"],[.5,1,.5],[1]],r:[[0,90,0],[0,90,0],[90],[0],[0]],t:[[0],[0],[0,1,0],[1,0,0],[0]],c:[[0,1],[1,.5],[7,1],[8,1],[5,5]]},1:{s:[[1,"1./q.y",1],[1,.1,1],[.5,.25,.5],[1],[1]],r:[[0,-90,0],[0],[0],[0,45,0],[0]],t:[[0],[1,0,1],[1,0,1],[0,1,0],[0]],c:[[6,0],[7,8],[8,0],[0,1],[1,1]]},2:{s:[["o.rand","o.rand*.25","o.rand"],["o.rand","o.rand*.25","o.rand"],["o.rand","o.rand*.5","o.rand"],[1,"o.rand*.75",1],[1]],r:[[0],["cos(o.uv.x*TAU*2.)*22.5",0,"sin(o.uv.y*TAU*2.)*22.5"],[0],[0,180,0],[0]],t:[[1,0,1],[0],[0],[1,0,1],[0]],c:[[2,1],[7,1],[4,1],[5,1],[8,1]]},3:{s:[[1,"1./q.y",1],[.75,"o.rand",.75],[.75,"o.rand",.75],["o.rand"],[1]],r:[[0],[0],[0,-45,0],[0,45,0],[0]],t:[[1],["o.rand",0,"o.rand"],[1,0,0],[0],[0]],c:[[8,2],[7,2],[8,1],[7,4],[5,3]]},4:{s:[["o.rand"],[.33],["o.rand"],["o.rand"],[1]],r:[[0],[0,0,90],[0,0,90],[0],[0]],t:[[3,0,3],[0],[0],[0],[0]],c:[[8,1],[2,1],[8,4],[5,3],[7,1]]},5:{s:[[1],["o.rand"],["o.rand"],["o.rand"],[1]],r:[[0,-45,0],[0],[0],[0],[0]],t:[[2,0,0],[1,0,1],["cos(o.uv.x*TAU*2.)*2.",0,"sin(o.uv.x*TAU*2.)*2."],["cos(o.uv.x*TAU)*4.",0,"sin(o.uv.y*TAU)*4."],[0]],c:[[4,1],[3,2],[7,4],[8,4],[0,1]]},6:{s:[[.5,.1,.5],[.5,.25,.5],[.5,"o.rand",.5],["o.rand"],[1]],r:[[0],[0],[0],[0,180,0],[0]],t:[["cos(o.uv.x*TAU*3.)*2.",0,0],[0,1,"sin(o.uv.x*TAU*3.)*2."],[0,0,1],[0],[0]],c:[[8,1],[0,1],[3,1],[5,4],[8,1]]},7:{s:[[1,"1./q.y",1],[1,"1./q.y",1],[1,.5,1],[1],[1]],r:[[0],[90,0,0],[0],[0],[0]],t:[[0,1,0],[0],[0],[0,1,"-sin(o.uv.x*TAU*3.)*2."],[0]],c:[[5,16],[7,16],[5,8],[6,5],[7,1]]},8:{s:[["o.rand"],["o.rand"],[.5],[1],[1]],r:[[0],[0,180,0],[0],[0],[0]],t:[[0],[0,1,0],[0],["int(cos(o.rand*TAU)*4.)",0,0],[0]],c:[[7,3],[8,2],[0,1],[8,8],[8,1]]},9:{s:[["o.rand"],["o.rand"],[1,"1./q.y",1],[1,"1./q.y",1],[1]],r:[[0,180,0],[0,0,0],[0,0,0],[90,180,90],[0]],t:[[0],["int(cos(o.uv.x*TAU)*5.)","cos(o.uv.y*TAU)*.5+.5","int(sin(o.uv.y*TAU)*5.)"],["int(cos(o.uv.x*TAU*3.)*5.)","cos(o.uv.x*TAU)*.5+.5","int(sin(o.uv.y*TAU*3.)*5.)"],[0],[0]],c:[[0,1],[7,2],[3,1],[7,1],[8,1]]},10:{s:[["o.rand"],["o.rand"],[1,"1./q.y",1],[1,"1./q.y",1],[1]],r:[[0,180,0],[0,0,0],[0,0,0],[90,180,90],[0]],t:[["int(cos(o.uv.x*TAU*8.)*5.)",0,"int(sin(o.uv.y*TAU*8.)*5.)"],["int(cos(o.uv.x*TAU*4.)*5.)",0,"int(sin(o.uv.y*TAU*4.)*5.)"],["int(cos(o.uv.x*TAU*2.)*5.)",0,"int(sin(o.uv.y*TAU*2.)*5.)"],[0],[0]],c:[[8,1],[8,1],[8,1],[0,1],[8,1]]}}};function parsePreset(e){for(var t in e){let n=[];const o=e[t];for(var a of o)"c"===t&&a.push(hl.randomInt(0,1)),n.push(1==(i=a).length?Array(3).fill(i[0]):i);e[t]=n}var i;return e}function createVectors(e){let t="";for(var a of e)t=t.concat(`vec3(${a}),`);return t.slice(0,-1)}function getVectors(e){let t={};for(var a in e)t[a]=createVectors(e[a]);return t}function getTransforms(e,t){const a=getVectors(parsePreset(transformPresets[t][e]));return`\n\n\t#define TRANSITIONS w\n\n\tstruct Data{\n\t\tvec3 sVals[w];\n\t\tvec3 rVals[w];\n\t\tvec3 tVals[w];\n\t};\n\n\tData getTransforms(Init o, vec3 q)\n\t{\n\t\tData d;\n\t\td.sVals=vec3[w](${a.s});\n\t\td.rVals=vec3[w](${a.r});\n\t\td.tVals=vec3[w](${a.t});\n\t\treturn d;\n\t}\n\tconst vec3[w] mutationCurves=vec3[w](${a.c});\n\t`.replace(/w/g,t)}let INFURA_API_KEY="2264186c7317466ab23a3148f2a97c03",INFURA_API_KEY_SECRET="nBF6KHqxJcS2jiwiA3D4AxS4cO/GmmPZw2tRydAGXUkOfPUK145W5A";const auth=btoa(INFURA_API_KEY+":"+INFURA_API_KEY_SECRET);let endpoint="https://mainnet.infura.io/v3/2264186c7317466ab23a3148f2a97c03";const web3=new Web3(new Web3.providers.HttpProvider(endpoint));function getRefreshRateSeconds(e){return 86400/(1e5/e.collectionSize)}async function getEtherscanData(e,t){let a=round(remap(e.gasUsedMint,20,200,0,1)),i=e.gasUsedMint;await axios.get("https://api.etherscan.io/api?module=gastracker&action=gasoracle&apikey=YV25ATMN8TKCNRCQ2RGVYTRAKPHXB3J9JX").then((e=>{const t=e.data.result;let n=t.gasUsedRatio;n=n.split(",").map(Number);const o=n.length;a=n.reduce(((e,t)=>e+t),0)/o,i=t.ProposeGasPrice})).catch((t=>{e.trafficSource="on mint",e.trafficError=!0,console.log("Error querying APIs, please try later. Using fallback for now (inaccurate data)",t)})),e.trafficLevel=a,e.trafficGas=i,t(e,a),console.log("Ethereum query completed.")}async function getTrafficLevel(e,t,a){if(t.trafficAllowed){t.trafficSource="live",t.trafficError=!1;try{const i=1,{data:n}=await axios.get(`https://gas.api.infura.io/networks/${i}/suggestedGasFees`,{headers:{Authorization:`Basic ${e}`}}),o=await web3.eth.getGasPrice(),r=web3.utils.fromWei(o,"gwei");let s=n.networkCongestion;t.trafficLevel=s,t.trafficGas=r,a(t,s),console.log("Ethereum query completed.")}catch(e){console.log("Error querying Infura",e),console.log("Trying Etherscan..."),getEtherscanData(t,a)}}}function nearestPow2(e){const t=Math.log2(e),a=Math.pow(2,Math.floor(t)),i=Math.pow(2,Math.ceil(t));return e-a<i-e?a:i}function getShadowMapSize(e=null){let t=Math.max(dim.x,dim.y);return null!==e&&(t=e),Math.min(nearestPow2(t)*p.shadowQuality,renderer.capabilities.maxTextureSize)}function setShadowMap(e=null){let t=getShadowMapSize(e);light1.shadow.mapSize.width=t,light1.shadow.mapSize.height=t,light1.shadow.map.dispose(),light1.shadow.map=null,light2.shadow.mapSize.width=t,light2.shadow.mapSize.height=t,light2.shadow.map.dispose(),light2.shadow.map=null}function makePointLight(e,t,a,i,n){let o=getShadowMapSize();const r=new THREE.PointLight(e,a,10);return r.position.set(t[0],t[1],t[2]),r.castShadow=!0,r.shadow.mapSize.width=o,r.shadow.mapSize.height=o,r.shadow.camera.near=.1,r.shadow.camera.far=10,r.shadow.radius=1.5,r.shadow.camera.top=5,r.shadow.camera.right=5,r.shadow.camera.bottom=-5,r.shadow.camera.left=-5,r.lookAt(i.position),n.add(r),r}const setArrayIdxs=(e,t,a)=>{e[t]=a[0],e[t+1]=a[1],e[t+2]=a[2]},setAttr=(e,t,a,i)=>{i.setAttribute(e,new THREE.InstancedBufferAttribute(t,a))},af32=e=>new Float32Array(3*e),ai32=e=>new Int32Array(e);function createAttributes(e){return{ids:ai32(e)}}function updateAttributes(e,t,a,i,n,o){e.ids[i]=o[0],t.position.set(0,0,0),t.updateMatrix(),a.setMatrixAt(i,t.matrix)}function setAttributes(e,t){setAttr("aID",e.ids,1,t)}function createInstances(e,t,a){Math.ceil(Math.sqrt(e));const i=new THREE.Object3D;let n=createAttributes(e);for(let t=0,o=0,r=e;t<r;t++,o+=3)updateAttributes(n,i,a,t,o,[t]);setAttributes(n,t),a.instanceMatrix.needsUpdate=!0}function getPalette(e,t){let a=palettes[e];return[...a.slice(-t),...a.slice(0,-t)]}function getColorModeName(e){return colorModeNames[e]}function selectPopulation(e){return{Sparse:hl.randomInt(35,50),Medium:hl.randomInt(70,90),High:hl.randomInt(100,120),Dense:hl.randomInt(140,150)}[e]}function setRatioName(){const e=Object.keys(ratioNames).find((e=>ratioNames[e]===p.ratioMode));p.ratioName=e}function setTrafficDirection(e){"Horizontal"===e?(p.trafficDirection.x=1,p.trafficDirection.y=0):"Vertical"===e?(p.trafficDirection.x=0,p.trafficDirection.y=1):(p.trafficDirection.x=1,p.trafficDirection.y=1)}function setTrafficGrade(e,t){const a=e.trafficLevels.length;t=parseInt(Math.min(.9999,t)*a),e.trafficGrade=e.trafficLevels[t],e.trafficGradeIndex=t}function selectEntropy(e){return{Low:hl.random(3,4),Medium:hl.random(4.5,6),High:hl.random(8,10)}[e]}function selectEntropyDetail(e){return{Coarse:2,Fine:3}[e]}function wRand(e,t){let a=[];for(let e=0;e<t.length;e+=1)a[e]=t[e]+(a[e-1]||0);let i=a[a.length-1]*hl.random();for(let t=0;t<e.length;t+=1)if(a[t]>=i)return e[t]}function add(e){return e.reduce(((e,t)=>e+t),0)}function normSum(e){let t=add(e);return e.map((e=>e*(1/t)))}let timeManager,dim,boundBox,scene,renderer,camera,material,noise,texturesAtlas,uniforms,gui,stats,light1,light2,ambientLight,colorModeNames=["Solid","Texture","Gradient"],rotationModes=["A","B","C","D","E"],populationNames=["Sparse","Medium","High","Dense"],paletteIndex=hl.randomInt(0,Object.keys(palettes).length-1),paletteName=Object.keys(palettes)[paletteIndex],paletteRotation=hl.randomInt(0,4),colorMode=wRand([1,2],normSum([2,1])),populationName=wRand(populationNames,normSum([1,2,1.25,.25])),population=selectPopulation(populationName),terrainSeed=100*hl.random(),textureFamily=hl.randomInt(1,5),familyName={1:"Quadrants",2:"Polka",3:"Flags",4:"Circles",5:"Dotted"}[textureFamily],entropyName=wRand(["Low","Medium","High"],normSum([2,.75,.25])),entropy=selectEntropy(entropyName),entropyDetailName=wRand(["Coarse","Fine"],normSum([2,.5])),entropyDetail=selectEntropyDetail(entropyDetailName),segments=wRand([4,5],normSum([2,1])),transformPreset=hl.randomInt(0,Object.keys(transformPresets[segments]).length-1),trafficCounter=0,p={render:!0,active:!0,trafficAllowed:!0,trafficEnabled:!1,isMobile:!1,showUI:!1,showInfo:!1,showShortcuts:!1,paletteName:paletteName,palette:getPalette(paletteName,paletteRotation),paletteIndex:paletteIndex,colorMode:colorMode,colorModeName:getColorModeName(colorMode),colorRotation:paletteRotation,colorRotationName:rotationModes[paletteRotation],population:populationName,dimensions:[population,population],noiseSeed:terrainSeed,transformPreset:transformPreset,textureFamily:textureFamily,textureName:familyName,collectionSize:110,date:getCurrentDate(),fps:60,totalSegments:segments,mutationSmooth:.25,frameInterval:1/60,smoothIncrement:0,seed:0,extFloatLinear:null,axialHighlight:.7,graniteThreshold:.85,graniteLevel:2,noiseShift:0,entropyName:entropyName,entropyDetailName:entropyDetailName,noiseFreq:3,noiseOctaves:entropyDetail,dotsMultiplier:150,dotsScale:.1,texturesDim:1080,texturesSmooth:5,textureNumColors:5,ratioMode:0,playback:"Full",segment:0,colorMorphing:!0,ratioName:null,mutationEnabled:!0,mutationCycle:1,mutationSpeed:.5,mutationMagnitude:.1,speed:.25,speedFactor:1,shadowType:"Soft",shadowResolution:"High",shadowQuality:2,trafficRefreshRate:1e5,trafficLevel:0,trafficGas:"n/a",trafficAxis:"Horizontal",trafficDirection:{x:0,y:0},trafficInvert:!1,trafficLevels:["minimal","sparse","light","moderately light","moderate","moderately high","high","severe","extreme"],trafficGrade:"inactive",trafficGradeIndex:-1,trafficUpdateCounter:0,trafficError:!1,trafficSource:"paused",gasUsedMint:hl.tx.gasUsed,gasPriceMint:hl.tx.gasPrice};function setCameraZoom(){if(p.adaptive)dim.a>1?camera.zoom=dim.a+1:camera.zoom=dim.y/dim.x+1;else if(dim.a<=1)camera.zoom=2.1;else{let e=p.ratioName;camera.zoom="4/3"===e?2.5:2.75}}function init(){p.isMobile=window.mobileCheck(),createStatusHTML(p.showInfo),createInfoHTML(p.showShortcuts),timeManager=new TimeManager,dim=getDim(p),scene=new THREE.Scene,setRatioName(),renderer=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!1,powerPreference:"high-performance"}),createContainer(renderer);let e=2;p.isMobile&&(e=Math.min(2,window.devicePixelRatio)),renderer.setPixelRatio(e),renderer.setSize(dim.x,dim.y),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFShadowMap,renderer.outputColorSpace=THREE.SRGBColorSpace;const t=renderer.getContext();p.extFloatLinear=t.getExtension("OES_texture_float_linear");const a=new THREE.MeshPhongMaterial;let i=new THREE.MeshDistanceMaterial({alphaTest:.5}),n=p.dimensions[0]*p.dimensions[1];noise=createNoiseTexture(renderer,p.dimensions,p.noiseSeed,p.noiseFreq,p.noiseShift,p.noiseOctaves),texturesAtlas=createTexturesTexture(renderer,[p.texturesDim,p.texturesDim],p,p.texturesSmooth),uniforms={uC1:u(toRGB(p.palette[0])),uC2:u(toRGB(p.palette[1])),uC3:u(toRGB(p.palette[2])),uC4:u(toRGB(p.palette[3])),uC5:u(toRGB(p.palette[4])),uNC:u(5),uCM:u(p.colorMorphing),uSeg:u(timeManager.currentSegment),uTime:u(0),uD:u(p.dimensions),uTr:u(p.totalSegments),sNoise:u(noise.texture),uMSm:u(p.mutationSmooth),uSc:u(1),uSeed:u(p.seed),uMode:u(p.colorMode),sTex:u(texturesAtlas.texture),uTexDim:u(p.texturesDim),uPp:u([p.axialHighlight,p.graniteThreshold,p.graniteLevel])};const o=getTransforms(p.transformPreset,p.totalSegments);let r=customPhongMaterial(a,uniforms,i,o);material=r[0],material.dithering=!0;let s=r[1],l=new THREE.BoxGeometry(1,1,1);l.translate(0,.5,0);let c=new THREE.InstancedMesh(l,material,n);c.customDistanceMaterial=s,c.frustumCulled=!0,c.castShadow=!0,c.receiveShadow=!0,c.needsUpdate=!0,scene.add(c),createInstances(n,l,c);new THREE.MeshBasicMaterial({map:texturesAtlas.texture});let d=new THREE.MeshPhongMaterial;const m=new THREE.PlaneGeometry(1,1),f=new THREE.Mesh(m,d),V=toRGB(p.palette[4]),h=new THREE.Color;h.setRGB(V[0],V[1],V[2]),f.material.color.set(h),f.receiveShadow=!0,f.position.set(0,-5e-4,0),f.rotation.x=toRadians(-90),scene.add(f);let x=new THREE.PlaneGeometry(1,1);x.translate(0,.5,0);let v=new THREE.ShaderMaterial;n=p.dotsMultiplier**2;v=customConstantMaterial(v,{uS:u(p.dotsScale),uD:u([p.dotsMultiplier,p.dotsMultiplier]),uC:u(toRGB(p.palette[3]))});let g=new THREE.InstancedMesh(x,v,n);scene.add(g),g.rotation.x=toRadians(-90),createInstances(n,x,g),ambientLight=new THREE.AmbientLight(16777215,.1),scene.add(ambientLight),light1=makePointLight(16777215,[-1,1,1],10,f,scene),light2=makePointLight(16777215,[1.8,1.5,0],10,f,scene),camera=new THREE.OrthographicCamera(-.5*dim.a,.5*dim.a,.5,-.5,.1,100),camera.position.set(5,5,5),camera.lookAt(c.position),setCameraZoom(),camera.updateProjectionMatrix(),camera.updateMatrix(),scene.add(camera),document.addEventListener("keydown",onDocumentKeyDown,!1),window.addEventListener("resize",onWindowResize,!1),makeUI(),toggleUI(gui,p.showUI),p.trafficRefreshRate=getRefreshRateSeconds(p),p.trafficUpdateCounter="paused",setTrafficDirection(p.trafficAxis),hl.token.setTraits({Palette:p.paletteName,"Color rotation":p.colorRotationName,"Color mode":p.colorModeName,Population:p.population,Transformations:p.totalSegments,Sequence:p.transformPreset,"Texture family":1===p.colorMode?p.textureName:"None",Entropy:p.entropyName,"Entropy detail":p.entropyDetailName}),renderer.render(scene,camera)}function remapExponentially(e,t){const a=Math.max(0,Math.min(1,e));return Math.pow(a,t)}let aspectController,playerController,lastRenderTime=0,seconds=0,frames=0,prevTime=performance.now(),currentFPS=0;function animate(e){const t=1e3/p.fps;requestAnimationFrame(animate);const a=e-lastRenderTime;if(a>t&&p.render){lastRenderTime=e-a%t,p.date=getCurrentDate(),seconds+=p.frameInterval,frames++;const i=performance.now();i>=prevTime+500&&(currentFPS=Math.round(1e3*frames/(i-prevTime)),frames=0,prevTime=i),noise.shader.shader.uniforms.uTime.value=seconds,noise.shader.shader.uniforms.uShift.value=timeManager.mutationValue*p.mutationMagnitude;const n=writeStaticTexture(renderer,p.dimensions,noise.shader.options,noise.shader.shader);material.uniforms.sNoise.value=n,material.uniforms.uTime.value=timeManager.dt,material.uniforms.uSeg.value=timeManager.currentSegment,material.uniforms.uCM.value=p.colorMorphing,material.uniforms.uMode.value=p.colorMode;let o=2*+p.trafficInvert-1,r=remapExponentially(1-p.trafficLevel,2),s=r*p.trafficEnabled*p.trafficDirection.x*o,l=r*p.trafficEnabled*p.trafficDirection.y*o;if(noise.shader.shader.uniforms.uTraffic.value=[s,l],renderer.render(scene,camera),timeManager.run(p),p.showInfo){updateInfo(createInfoData(timeManager,p),seconds,currentFPS)}p.trafficUpdateCounter="paused",p.trafficEnabled&&(trafficCounter+=p.frameInterval,p.trafficUpdateCounter=Math.max(0,p.trafficRefreshRate-trafficCounter).toFixed(2),trafficCounter>p.trafficRefreshRate&&(getTrafficLevel(auth,p,setTrafficGrade),trafficCounter=0,p.trafficUpdateCounter=p.trafficRefreshRate.toFixed(2)))}}function onDocumentKeyDown(e){let t=e.key;if(e.shiftKey)switch(t){case"P":p.showUI=!p.showUI,toggleUI(gui,p.showUI);break;case"S":p.showInfo=!p.showInfo;const e=document.getElementById("info");p.showInfo?e.style.display="inline-block":e.style.display="none";break;case" ":p.active=!p.active,playerController.updateDisplay();break;case"E":exportCustom(3840,!1,null);break;case"O":exportCustom(2560,!0,3840);break;case"I":p.showShortcuts=!p.showShortcuts;const t=document.getElementById("shortcuts");p.showShortcuts?t.style.display="inline-block":t.style.display="none"}else if(e.altKey)switch(t){case"0":case"1":case"2":case"3":case"4":case"5":const e=parseInt(t);p.ratioMode=e,resize(),setRatioName(),aspectController.updateDisplay()}}function resize(e=null,t=null){dim=getDim(p,e),camera.left=-.5*dim.a,camera.right=.5*dim.a,setShadowMap(t),setCameraZoom(),camera.updateProjectionMatrix(),camera.updateMatrix(),renderer.setSize(dim.x,dim.y),renderer.render(scene,camera)}function disableController(e,t){e.__li.style=t?"opacity: 1.0; pointer-events: auto;":"opacity: 0.5; pointer-events: none;"}function toggleUI(e,t){e.domElement.style.display=t?"":"none"}function updateColor(){material.uniforms.uC1.value=toRGB(p.palette[0]),material.uniforms.uC2.value=toRGB(p.palette[1]),material.uniforms.uC3.value=toRGB(p.palette[2]),material.uniforms.uC4.value=toRGB(p.palette[3]),material.uniforms.uC5.value=toRGB(p.palette[4])}function makeUI(){let e;gui=new dat.GUI;const t=gui.addFolder("Aspect ratio"),a=Object.keys(ratioNames);aspectController=t.add(p,"ratioName",a).name("Mode"),aspectController.onChange((e=>{p.ratioMode=ratioNames[e],resize()}));const i=gui.addFolder("Colors");i.add(p,"colorMorphing").name("Morphing"),e=i.add(p,"colorModeName",colorModeNames).name("Mode"),e.onChange((e=>{p.colorMode=colorModeNames.indexOf(e),updateColor()})),e=i.add(p,"colorRotationName",rotationModes).name("Rotation"),e.onChange((e=>{const t=rotationModes.indexOf(e);p.colorRotation=t,p.palette=getPalette(p.paletteName,t),updateColor(),texturesAtlas=createTexturesTexture(renderer,[p.texturesDim,p.texturesDim],p,p.texturesSmooth),material.uniforms.sTex.value=texturesAtlas.texture}));gui.addFolder("Transformation").add(p,"speed",0,2,.01).name("Speed multiplier");const n=gui.addFolder("Mutation");n.add(p,"mutationEnabled").name("Enable"),n.add(p,"mutationCycle",1,25,1).name("Cycle"),n.add(p,"mutationSpeed",0,2,.01).name("Speed multiplier"),n.add(p,"mutationMagnitude",0,1,.01).name("Magnitude");const o=gui.addFolder("Animation");playerController=o.add(p,"active").name("Play");const r=o.add(p,"playback",["Full","Custom","Discrete","Mutation"]).name("Mode"),s=o.add(p,"segment",0,p.totalSegments,1).name("Segment");disableController(s,!1),r.onChange((e=>{p.playback=e,disableController(s,"Custom"==e||"Discrete"==e)}));const l=gui.addFolder("Traffic mode"),c=l.add(p,"trafficEnabled").name("Activate"),d=l.add(p,"trafficAxis",["Horizontal","Vertical","Diagonal"]).name("Axis");d.onChange((e=>{setTrafficDirection(e)}));const u=l.add(p,"trafficInvert").name("Invert");c.onChange((e=>{e&&(p.trafficAllowed?getTrafficLevel(auth,p,setTrafficGrade):(p.trafficSource="paused",p.trafficGrade="inactive")),disableController(d,e),disableController(u,e)})),disableController(d,!1),disableController(u,!1);const m=gui.addFolder("System");m.add(p,"render").name("Rendering"),e=m.add(p,"fps").name("FPS"),e.onChange((e=>{p.frameInterval=1/e})),m.add(p,"trafficAllowed").name("Ethereum queries");const f=gui.addFolder("Shadows");e=f.add(p,"shadowType",["Hard","Soft"]).name("Type"),e.onChange((e=>{renderer.shadowMap.type={Soft:1,Hard:0}[e],scene.traverse((e=>{e.material&&(e.material.needsUpdate=!0)}))}));e=f.add(p,"shadowResolution",["Medium","High","Ultra"]).name("Quality"),e.onChange((e=>{p.shadowQuality=Math.pow(2,{Medium:1,High:2,Ultra:3}[e]),setShadowMap()}));const V=gui.addFolder("Export");let h;h={export4k:function(){exportCustom(3840,!1,null)}},e=V.add(h,"export4k").name("4k"),h={export8k:function(){exportCustom(2560,!0,3840)}},e=V.add(h,"export8k").name("8k")}function onWindowResize(){resize()}const saveFile=function(e,t){const a=document.createElement("a");"string"==typeof a.download?(document.body.appendChild(a),a.download=t,a.href=e,a.click(),document.body.removeChild(a)):location.replace(uri)};function exportCustom(e,t,a){const i=hl.tx.tokenId;getDim(p).y;resize(e/2,a);const n=dim.x/3,o=dim.y/3;let r;var s="image/octet-stream";Date.now||(Date.now=function(){return(new Date).getTime()});let l=Math.floor(Date.now()/1e3);try{if(t){let e=0;for(let t=0;t<dim.y;t+=o)for(let a=0;a<dim.x;a+=n){camera.setViewOffset(dim.x,dim.y,a,t,n,o),renderer.render(scene,camera);const c="image/png";r=renderer.domElement.toDataURL(c),saveFile(r.replace(c,s),`Metamorphosis_1_#${i}_${l}_${e++}.png`)}camera.clearViewOffset(),camera.updateProjectionMatrix()}else{renderer.render(scene,camera);const e="image/png";r=renderer.domElement.toDataURL(e),saveFile(r.replace(e,s),`Metamorphosis_1_#${i}_${l}.png`)}}catch(e){return void console.log(e)}resize()}init(),hl.token.capturePreview(),animate();